# Build stage
FROM golang:1.21-alpine AS builder

WORKDIR /build

# Copy simulator files
COPY simulator/go.mod ./
COPY simulator/dx_simulator.go ./

# Download dependencies (if any)
RUN go mod download || true

# Build
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o dx_simulator .

# Runtime stage
FROM alpine:latest

RUN apk --no-cache add ca-certificates wget

WORKDIR /app

COPY --from=builder /build/dx_simulator .

# Script inline para aguardar servidor
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'echo "ðŸ”§ Aguardando servidor NXD..."' >> /entrypoint.sh && \
    echo 'until wget -q -O- http://nxd-server:8080/api/health >/dev/null 2>&1; do' >> /entrypoint.sh && \
    echo '  echo "  Tentando conectar..."' >> /entrypoint.sh && \
    echo '  sleep 2' >> /entrypoint.sh && \
    echo 'done' >> /entrypoint.sh && \
    echo 'echo "âœ“ Servidor pronto!"' >> /entrypoint.sh && \
    echo 'echo "ðŸš€ Iniciando simulador DX..."' >> /entrypoint.sh && \
    echo 'if [ -z "$API_KEY" ]; then' >> /entrypoint.sh && \
    echo '  echo "âŒ API_KEY nÃ£o definida"' >> /entrypoint.sh && \
    echo '  exit 1' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo 'echo "âœ“ API Key: ${API_KEY:0:20}..."' >> /entrypoint.sh && \
    echo 'exec ./dx_simulator "$API_KEY"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
